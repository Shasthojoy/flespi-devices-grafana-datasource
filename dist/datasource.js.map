{"version":3,"sources":["../src/datasource.js"],"names":["_","FlespiDevicesDatasource","instanceSettings","$q","backendSrv","templateSrv","type","jsonData","undefined","url","uri","headers","token","name","q","param","target","device_ids","multiple_devices","indexOf","devices","split","i","length","device","push","substring","lastIndexOf","join","devices_reg","metricFindQuery","parameter","multiple_params","replace","options","query","buildQueryParameters","targets","filter","t","hide","Promise","resolve","data","from","parseInt","Date","parse","range","to","interval_sec","scopedVars","__interval_ms","value","prepareDeviceIds","parameters","prepareParameters","request_params","fields","func","maxDataPoints","gen_interval","generalize","method","doRequest","JSON","stringify","then","messages","response","result","createMultipleDevicesTimeseries","createSingleDeviceTimeseries","dict","message","timestamp","is_skip_param","device_id","device_label","datapoints","status","title","catch","error","annotation","annotationQuery","datasource","enable","iconColor","rangeRaw","res","device_name","label","id","text","errors","methos","params_set","telemetry","endsWith","map","d","isObject","datasourceRequest","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class FlespiDevicesDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    if (instanceSettings.jsonData != undefined) {\n      this.url = instanceSettings.jsonData.uri;\n      this.headers = {'Authorization': 'FlespiToken ' + instanceSettings.jsonData.token, 'Content-Type': 'application/json'};\n    } else {\n      this.url = \"\";\n      this.headers = {};\n    }\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n  }\n\n  is_skip_param(param) {\n    switch(param) {\n      case \"channel_id\":\n      case \"device_id\":\n      case \"ident\":\n      case \"device_name\":\n      case \"timestamp\":\n      case \"position\":\n        return true;\n      default:\n        return false;\n    }\n  }\n\n  prepareDeviceIds(target) {\n    let device_ids = \"all\";\n    if (target == \"$device\" || target == \"all\") {\n      device_ids = \"all\";\n      this.multiple_devices = true;\n    } else if (target.indexOf(',') !== -1) {\n      // multiple devices\n      const devices = target.split(',');\n      device_ids = [];\n      for (let i = 0; i < devices.length; i++) {\n        const device = devices[i];\n        device_ids.push(device.substring(device.lastIndexOf('#') + 1));\n      }\n      device_ids = device_ids.join(',');\n      this.multiple_devices = true;\n    } else {\n      // single device\n      device_ids = target.substring(target.lastIndexOf('#') + 1);\n      this.multiple_devices = false;\n    }\n    if (this.devices_reg == undefined) {\n      this.metricFindQuery(\"devices\");\n    }\n    return device_ids;\n  }\n\n  prepareParameters(parameter) {\n    if (parameter === \"select parameter\" || parameter === \"all\") {\n      // will return all messages by default\n      this.multiple_params = true;\n      return null;\n    }\n    if (parameter.indexOf(',') !== -1 || parameter.indexOf('*') !== -1) {\n      // comma-separated list or wildcard parameters\n      this.multiple_params = true;\n    } else {\n      // single parameter\n      this.multiple_params = false;\n    }\n    if (parameter.indexOf('#') !== -1) {\n      // urlescape # in parameter name\n      parameter = parameter.replace(/#/g, '%23');\n    }\n    return parameter;\n  }\n\n  query(options) {\n    let query = this.buildQueryParameters(options);\n    query.targets = query.targets.filter(t => !t.hide);\n\n    if (query.targets == null || query.targets.length <= 0 || !query.targets[0].target) {\n      return Promise.resolve({data: []});\n    }\n\n    // prepare params of request\n    const from = parseInt(Date.parse(query.range.from) / 1000);\n    const to = parseInt(Date.parse(query.range.to) / 1000);\n    const interval_sec = query.scopedVars.__interval_ms.value / 1000\n    const device_ids = this.prepareDeviceIds(query.targets[0].target);\n    const parameters = this.prepareParameters(query.targets[0].parameter);\n    if (this.multiple_devices === true && this.multiple_params === true) {\n      // attempt to show multiple parameters for multiple devices on one plot, don't process it\n      return Promise.resolve({data: []});\n    }\n    const request_params = {from: from, to : to}\n    if (parameters !== null) {\n      request_params.fields = parameters + \",timestamp,device_id\";\n      if (parameters.indexOf('*') === -1) {\n        request_params.filter = parameters;\n      }\n    }\n\n  if (query.targets[0].func != undefined && query.targets[0].func != '') {\n    if (interval_sec >= 60 || (interval_sec !== 0 && query.maxDataPoints > 0 && ((to - from)/interval_sec > query.maxDataPoints))) {\n        // apply generalization function\n        const gen_interval = (to - from)/query.maxDataPoints;\n        request_params.generalize = gen_interval >= 60 ? parseInt(gen_interval) : 60;\n        if (query.targets[0].func == \"avg\") {\n            request_params.method = \"average\";\n        } else if (query.targets[0].func == \"max\") {\n            request_params.method = \"maximum\";\n        } else {\n            request_params.method = \"minimum\";\n        }\n    }\n  }\n    return this.doRequest({\n      url: this.url + '/gw/devices/' + device_ids + '/messages?data=' + JSON.stringify(request_params),\n      method: 'GET'\n    }).then(response => {\n      // parse response: convert device messages to timeseries\n      const messages = response.data.result;\n      if (!messages || messages.length == 0) {\n        // empty response - no data points\n        return {data: []};\n      }\n      if (this.multiple_devices === true) {\n        return this.createMultipleDevicesTimeseries(messages);\n      } else {\n        return this.createSingleDeviceTimeseries(messages);\n      }\n    });\n  }\n\n  createMultipleDevicesTimeseries(messages) {\n    // mutiple devices, but only one parameter\n    const data = [];\n    const dict = {};\n    for (let i = 0; i < messages.length; i++) {\n      const message = messages[i];\n      const timestamp = message.timestamp;\n      for (let param in message) {\n        if (this.is_skip_param(param) === true) {\n          continue;\n        }\n        let value = message[param];\n        if (typeof value == \"boolean\") {\n          value = (value == true) ? 1 : 0;\n        }\n        if (typeof value != \"number\") {\n          continue;\n        }\n        const device_id = message.device_id;\n        if (device_id == undefined || device_id == null || this.devices_reg == undefined || this.devices_reg[device_id] == undefined) {\n          return {data: []};    // unknown device - return empty datapoints\n        }\n        const device_label = this.devices_reg[device_id];\n        if (!dict[device_label]) {\n          // create separate datapoints array for each device\n          dict[device_label] = {\n              datapoints: []\n          }\n        }\n        dict[device_label].datapoints.push([value, timestamp * 1000]);\n      }\n    }\n    // format parameters dictionary to timeseries\n    for (let device_label in dict) {\n      data.push({\n          target: device_label,\n          datapoints: dict[device_label].datapoints\n      });\n    }\n    return {data: data};\n  }\n\n  createSingleDeviceTimeseries(messages) {\n    // only one device, but can contain multiple parameters\n    const data = [];\n    const dict = {};\n    for (let i = 0; i < messages.length; i++) {\n      const message = messages[i];\n      const timestamp = message.timestamp;\n      for (let param in message) {\n        if (this.is_skip_param(param) === true) {\n          continue;\n        }\n        let value = message[param];\n        if (typeof value == \"boolean\") {\n          value = (value == true) ? 1 : 0;\n        }\n        if (typeof value != \"number\") {\n          continue;\n        }\n        if (!dict[param]) {\n          // create separate dataapoints array for each parameter\n          dict[param] = {\n              datapoints: []\n          }\n        }\n        dict[param].datapoints.push([value, timestamp * 1000]);\n      }\n    }\n    // format parameters dictionary to timeseries\n    for (let param in dict) {\n      data.push({\n          target: param,                      // target: parameter.name\n          datapoints: dict[param].datapoints  // datapoints: array of [value, timestamp]\n      });\n    }\n    return {data: data};\n  }\n\n  testDatasource() {\n    return this.doRequest({\n      url: this.url + '/gw/devices/all',\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    }).catch(error => {\n      if (error.status === 401) {\n        return { status: \"error\", message: \"Invalid or expired access token\" };\n      } else {\n        return { status: \"error\", message: \"Request error, code:\" + error.status };\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    let query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    let annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.doRequest({\n      url: this.url + '/annotations',\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      return result.data;\n    });\n  }\n\n  metricFindQuery(query) {\n    query = this.templateSrv.replace(query, null, 'csv');\n    if (query === \"devices\") {\n      return this.doRequest({\n        url: this.url + '/gw/devices/all',\n        method: 'GET',\n      }).then(response => {\n        const devices_reg = {};     // devices registry, contains device_id: label fields\n        const res = [];\n        const data = response.data.result;\n        for (let i = 0; i < data.length; i++) {\n            let device_name = data[i].name;\n            if (device_name.indexOf(',') !== -1) {\n              device_name = device_name.replace(/,/g, '');\n            }\n            const label = device_name + ' #' + data[i].id;\n            devices_reg[data[i].id] = label;\n            res.push({value: label, text: label});\n        }\n        this.devices_reg = devices_reg;\n        return res;\n      }).catch(error => {\n        if (error.status === 401) {\n          throw {\n            message: \"Invalid or expired access token\",\n            error: error.data.errors[0],\n          };\n        }\n        throw error;\n      });\n    } else if (query === \"parameters\") {\n      // get all parameters of all devices\n      return this.doRequest({\n        url: this.url + '/gw/devices/all/telemetry',\n        methos: 'GET',\n      }).then(response => {\n        const params_set = [];\n        const data = response.data.result;\n        for (let i = 0; i < data.length; i++) {\n          const telemetry = data[i].telemetry;\n          for (let param in telemetry) {\n            if (this.is_skip_param(param) === true) {\n              continue;\n            }\n            if (typeof telemetry[param].value != \"number\" && typeof telemetry[param].value != \"boolean\") {\n              // only numeric and boolean parameters are allowed for visualization\n              continue;\n            }\n            if (params_set.indexOf(param) == -1) {\n              // store new param\n              params_set.push(param);\n            }\n          }\n        }\n        const res = [];\n        for (let i = 0; i < params_set.length; i++) {\n          const param = params_set[i];\n          res.push({value: param, text: param});\n        }\n        return res;\n      }).catch(error => {\n        if (error.status === 401) {\n          throw {\n            message: \"Invalid or expired access token\",\n            error: error.data.errors[0],\n          };\n        }\n        throw error;\n      });\n    } else if (query.endsWith(\".parameters\")) {\n      // get parameters of the selected devices\n      const devices = query.replace('.parameters', '');\n      const device_ids = this.prepareDeviceIds(devices);\n\n      return this.doRequest({\n        url: this.url + '/gw/devices/' + device_ids + '/telemetry',\n        methos: 'GET',\n      }).then(response => {\n        const params_set = [];\n        const data = response.data.result;\n        for (let i = 0; i < data.length; i++) {\n          const telemetry = data[i].telemetry;\n          for (let param in telemetry) {\n            if (this.is_skip_param(param) === true) {\n              continue;\n            }\n            if (typeof telemetry[param].value != \"number\" && typeof telemetry[param].value != \"boolean\") {\n              // only numeric and boolean parameters are allowed for visualization\n              continue;\n            }\n            if (params_set.indexOf(param) == -1) {\n              // store new param\n              params_set.push(param);\n            }\n          }\n        }\n        const res = [];\n        for (let i = 0; i < params_set.length; i++) {\n          const param = params_set[i];\n          res.push({value: param, text: param});\n        }\n        return res;\n      }).catch(error => {\n        if (error.status === 401) {\n          throw {\n            message: \"Invalid or expired access token\",\n            error: error.data.errors[0],\n          };\n        }\n        throw error;\n      });\n    }\n    // empty result for incorrect query\n    return Promise.resolve([]);\n  }\n\n  mapToTextValue(result) {\n    return _.map(result.data, (d, i) => {\n      if (d && d.text && d.value) {\n        return { text: d.text, value: d.value };\n      } else if (_.isObject(d)) {\n        return { text: d, value: i};\n      }\n      return { text: d, value: d };\n    });\n  }\n\n  doRequest(options) {\n    options.headers = this.headers;\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  buildQueryParameters(options) {\n    // remove placeholder targets\n    options.targets = _.filter(options.targets, target => {\n      return target.target !== 'select device';\n    });\n\n    let targets = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target, options.scopedVars, 'csv'),\n        parameter: this.templateSrv.replace(target.parameter, options.scopedVars, 'csv'),\n        refId: target.refId,\n        hide: target.hide,\n        type: target.type || 'timeserie',\n        func: this.templateSrv.replace(target.func)\n      };\n    });\n\n    options.targets = targets;\n\n    return options;\n  }\n\n}\n"]}